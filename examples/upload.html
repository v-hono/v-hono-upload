<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-Hono åˆ†ç‰‡ä¸Šä¼ ç¤ºä¾‹</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: #007bff;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .file-input {
            display: none;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .file-info {
            margin: 10px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        .chunk-status {
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ V-Hono åˆ†ç‰‡ä¸Šä¼ ç¤ºä¾‹</h1>
        <p>æ”¯æŒå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ã€æ–­ç‚¹ç»­ä¼ ã€ç§’ä¼ åŠŸèƒ½</p>
        
        <div class="upload-area" id="uploadArea">
            <p>ğŸ“ æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
            <input type="file" id="fileInput" class="file-input" multiple>
            <button class="btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
        </div>

        <div class="file-info" id="fileInfo">
            <h3>æ–‡ä»¶ä¿¡æ¯</h3>
            <p><strong>æ–‡ä»¶å:</strong> <span id="fileName"></span></p>
            <p><strong>æ–‡ä»¶å¤§å°:</strong> <span id="fileSize"></span></p>
            <p><strong>åˆ†ç‰‡æ•°é‡:</strong> <span id="chunkCount"></span></p>
            <p><strong>åˆ†ç‰‡å¤§å°:</strong> <span id="chunkSize"></span></p>
        </div>

        <div class="progress-container" id="progressContainer">
            <h3>ä¸Šä¼ è¿›åº¦</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="chunk-status" id="chunkStatus"></div>
        </div>

        <div class="status" id="status"></div>

        <button class="btn" id="uploadBtn" onclick="startUpload()" style="display: none;">å¼€å§‹ä¸Šä¼ </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/spark-md5@3.0.2/spark-md5.min.js"></script>
    <script>
        const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB
        let selectedFile = null;
        let fileHash = null;
        let totalChunks = 0;
        let uploadedChunks = 0;

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        // æ‹–æ‹½å¤„ç†
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileSelect();
            }
        });

        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            resetUploadState();

            selectedFile = file;
            totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('chunkCount').textContent = totalChunks;
            document.getElementById('chunkSize').textContent = formatFileSize(CHUNK_SIZE);
            
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('uploadBtn').style.display = 'inline-block';
            
            // è®¡ç®—æ–‡ä»¶hash
            calculateFileHash(file).then(hash => {
                fileHash = hash;
                console.log('File hash:', hash);
            });
        }

        // é‡ç½®ä¸Šä¼ çŠ¶æ€
        function resetUploadState() {
            // é‡ç½®è¿›åº¦æ¡
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('chunkStatus').textContent = '';
            
            // éšè—è¿›åº¦å®¹å™¨
            document.getElementById('progressContainer').style.display = 'none';
            
            // é‡ç½®çŠ¶æ€ä¿¡æ¯
            document.getElementById('status').style.display = 'none';
            
            // é‡ç½®ä¸Šä¼ æŒ‰é’®
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'å¼€å§‹ä¸Šä¼ ';
            
            // é‡ç½®å˜é‡
            uploadedChunks = 0;
        }

        async function startUpload() {
            if (!selectedFile || !fileHash) {
                showStatus('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';

            document.getElementById('progressContainer').style.display = 'block';
            showStatus('å¼€å§‹ä¸Šä¼ ...', 'success');

            try {
                // ç›´æ¥å¼€å§‹ä¸Šä¼ åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡éƒ½ä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨
                for (let i = 0; i < totalChunks; i++) {
                    const chunk = selectedFile.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                    const chunkHash = await calculateChunkHash(chunk);

                    // æ£€æŸ¥åˆ†ç‰‡æ˜¯å¦å·²å­˜åœ¨ï¼ˆåŒ…æ‹¬ç§’ä¼ æ£€æµ‹ï¼‰
                    const checkResult = await checkChunkExists(fileHash, i, chunkHash);
                    
                    // å¦‚æœæ£€æµ‹åˆ°æ‰€æœ‰åˆ†ç‰‡éƒ½å·²ä¸Šä¼ å®Œæˆï¼Œç«‹å³ç»“æŸä¸Šä¼ 
                    if (checkResult.all_uploaded) {
                        console.log('æ£€æµ‹åˆ°ç§’ä¼ ï¼Œæ‰€æœ‰åˆ†ç‰‡éƒ½å·²ä¸Šä¼ å®Œæˆï¼');
                        updateProgress(totalChunks, totalChunks); // æ›´æ–°è¿›åº¦åˆ°100%
                        showStatus('ç§’ä¼ æˆåŠŸï¼æ–‡ä»¶å·²å®Œæ•´ä¸Šä¼ ã€‚', 'success');
                        uploadBtn.textContent = 'ä¸Šä¼ å®Œæˆ';
                        return;
                    }
                    
                    // å¦‚æœåˆ†ç‰‡å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸Šä¼ 
                    if (checkResult.exists) {
                        console.log(`åˆ†ç‰‡ ${i} å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸Šä¼ `);
                        updateProgress(i + 1, totalChunks);
                        continue;
                    }

                    // ä¸Šä¼ åˆ†ç‰‡
                    await uploadChunk(selectedFile, chunk, {
                        fileHash, chunkIndex: i, totalChunks, chunkHash
                    });
                    
                    updateProgress(i + 1, totalChunks);
                    console.log(`åˆ†ç‰‡ ${i} ä¸Šä¼ å®Œæˆ`);
                }

                showStatus('ä¸Šä¼ å®Œæˆï¼æ–‡ä»¶å·²è‡ªåŠ¨åˆå¹¶ã€‚', 'success');
                uploadBtn.textContent = 'ä¸Šä¼ å®Œæˆ';
                
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showStatus('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'é‡æ–°ä¸Šä¼ ';
            }
        }

        // è®¡ç®—æ–‡ä»¶hash
        async function calculateFileHash(file) {
            return new Promise(resolve => {
                const spark = new SparkMD5.ArrayBuffer();
                const reader = new FileReader();
                reader.onload = e => {
                    spark.append(e.target.result);
                    resolve(spark.end());
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // è®¡ç®—åˆ†ç‰‡hash
        async function calculateChunkHash(chunk) {
            return new Promise(resolve => {
                const spark = new SparkMD5.ArrayBuffer();
                const reader = new FileReader();
                reader.onload = e => {
                    spark.append(e.target.result);
                    resolve(spark.end());
                };
                reader.readAsArrayBuffer(chunk);
            });
        }



        // æ£€æŸ¥åˆ†ç‰‡hashæ˜¯å¦å·²å­˜åœ¨
        async function checkChunkExists(fileHash, chunkIndex, chunkHash) {
            const res = await fetch('/upload/chunk_exists?file_hash=' + fileHash + '&chunk_index=' + chunkIndex + '&chunk_hash=' + chunkHash + '&file_size=' + selectedFile.size + '&trunk_size=' + CHUNK_SIZE);
            if (!res.ok) return false;
            const data = await res.json();
            
            // å¦‚æœæ‰€æœ‰åˆ†ç‰‡éƒ½å·²ä¸Šä¼ å®Œæˆï¼Œç›´æ¥è¿”å› true è¡¨ç¤ºç§’ä¼ æˆåŠŸ
            if (data.all_chunk_uploaded) {
                console.log('æ‰€æœ‰åˆ†ç‰‡éƒ½å·²ä¸Šä¼ å®Œæˆï¼Œç§’ä¼ æˆåŠŸï¼');
                return { exists: true, all_uploaded: true };
            }
            
            return { exists: data.exists, all_uploaded: false };
        }

        // ä¸Šä¼ åˆ†ç‰‡
        async function uploadChunk(file, chunk, { fileHash, chunkIndex, totalChunks, chunkHash }) {
            const form = new FormData();
            form.append('file_hash', fileHash);
            form.append('chunk_index', chunkIndex);
            form.append('total_chunks', totalChunks);
            form.append('filename', file.name);
            form.append('file_size', file.size);
            form.append('chunk_size', CHUNK_SIZE);
            form.append('chunk_hash', chunkHash);
            form.append('chunk', chunk, file.name + '.part' + chunkIndex);

            const response = await fetch('/upload/chunk', { 
                method: 'POST', 
                body: form 
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'ä¸Šä¼ å¤±è´¥');
            }
            
            const result = await response.json();
            if (result.all_chunk_uploaded) {
                console.log('æ‰€æœ‰åˆ†ç‰‡å·²ä¸Šä¼ å®Œæˆï¼Œæ–‡ä»¶å·²è‡ªåŠ¨åˆå¹¶:', result.file_path);
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(current, total) {
            const percentage = (current / total) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('chunkStatus').textContent = current + '/' + total + ' åˆ†ç‰‡å·²ä¸Šä¼  (' + percentage.toFixed(1) + '%)';
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html> 